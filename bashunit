#!/bin/bash
set -euo pipefail

# shellcheck disable=SC2034
declare -r BASHUNIT_VERSION="0.16.0"

# shellcheck disable=SC2155
declare -r BASHUNIT_ROOT_DIR="$(dirname "${BASH_SOURCE[0]}")"
export BASHUNIT_ROOT_DIR

source "$BASHUNIT_ROOT_DIR/src/dev/debug.sh"
source "$BASHUNIT_ROOT_DIR/src/str.sh"
source "$BASHUNIT_ROOT_DIR/src/default_env_config.sh"
source "$BASHUNIT_ROOT_DIR/src/env_configuration.sh"
source "$BASHUNIT_ROOT_DIR/src/check_os.sh"
source "$BASHUNIT_ROOT_DIR/src/clock.sh"
source "$BASHUNIT_ROOT_DIR/src/state.sh"
source "$BASHUNIT_ROOT_DIR/src/colors.sh"
source "$BASHUNIT_ROOT_DIR/src/console_header.sh"
source "$BASHUNIT_ROOT_DIR/src/console_results.sh"
source "$BASHUNIT_ROOT_DIR/src/helpers.sh"
source "$BASHUNIT_ROOT_DIR/src/upgrade.sh"
source "$BASHUNIT_ROOT_DIR/src/assertions.sh"
source "$BASHUNIT_ROOT_DIR/src/logger.sh"
source "$BASHUNIT_ROOT_DIR/src/runner.sh"
source "$BASHUNIT_ROOT_DIR/src/bashunit.sh"
source "$BASHUNIT_ROOT_DIR/src/main.sh"

_ASSERT_FN_KEY=()
_ASSERT_FN_VALUES=()
_FILTER=""
_ARGS=()

while [[ $# -gt 0 ]]; do
  argument="$1"
  case $argument in
    -a|--assert)
      _ASSERT_FN_KEY+=("$2")
      _ASSERT_FN_VALUES+=("$3")
      shift 2
      ;;
    -f|--filter)
      _FILTER="$2"
      shift
      ;;
    -s|--simple)
      export BASHUNIT_SIMPLE_OUTPUT=true
      ;;
    -vvv|--verbose)
      export BASHUNIT_SIMPLE_OUTPUT=false
      ;;
    --debug)
      OUTPUT_FILE="${2:-}"
      if [[ -n $OUTPUT_FILE ]]; then
        exec > "$OUTPUT_FILE" 2>&1
      fi
      set -x
      ;;
    -S|--stop-on-failure)
      export BASHUNIT_STOP_ON_FAILURE=true
      ;;
    -e|--env|--load)
      # shellcheck disable=SC1090
      source "$2"
      shift
      ;;
    -l|--log-junit)
      export BASHUNIT_LOG_JUNIT="$2";
      shift
      ;;
    -r|--report-html)
      export BASHUNIT_REPORT_HTML="$2";
      shift
      ;;
    -v|--version)
      console_header::print_version
      trap '' EXIT && exit 0
      ;;
    --upgrade)
      upgrade::upgrade
      trap '' EXIT && exit 0
      ;;
    --help)
      console_header::print_help
      trap '' EXIT && exit 0
      ;;
    *)
      while IFS='' read -r line; do
        _ARGS+=("$line");
      done < <(helper::find_files_recursive "$argument")
      ;;
  esac
  shift
done

# shellcheck disable=SC1090
[[ -f "$BASHUNIT_LOAD_FILE" ]] && source "$BASHUNIT_LOAD_FILE"

set +eu

if [[ ${#_ASSERT_FN_KEY[@]} -gt 0 ]]; then
  output=""
  last_exit_code=0

  for i in "${!_ASSERT_FN_KEY[@]}"; do
    assert_fn="${_ASSERT_FN_KEY[$i]}"
    assert_value="${_ASSERT_FN_VALUES[$i]}"

    if [[ -n "$output" ]]; then
      # Pass the output from the previous assertion as input to the next
      output=$(main::exec_assert "$assert_fn" "$assert_value" "$output" )
    else
      # First assertion, run with original args
      output=$(main::exec_assert "$assert_fn" "$assert_value" "${_ARGS[@]}" )
    fi

    last_exit_code=$?
    if [[ $last_exit_code -ne 0 ]]; then
      break  # Stop if any assertion fails
    fi
  done
  exit $last_exit_code
else
  main::exec_tests "$_FILTER" "${_ARGS[@]}"
fi
